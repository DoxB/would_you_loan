<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/Pretendard/Pretendard.css" type="text/css" />

    <!-- 사용자 정의 CSS -->
<link rel="stylesheet" href="/css/common.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .box {
            margin-top: 50px;
            background-color: #fff;
            padding: 5%;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .form-control {
            margin-bottom: 20px;
        }
        .btn-change {
            margin-left: 10px;
        }
    </style>
</head>
<body>

<!--헤더-->
<header th:replace="fragments/header :: nav"></header>

<!--본문-->
<div class="content-wrapper">

<!--본문 내용 입력하기-->
    <div class="box">
        <h2 class="mb-5">회원정보</h2>
        <div class="col-7">
            <form>
                <div class="mb-3">
                    <label for="name" class="form-label">이름</label>
                    <input type="text" class="form-control" id="name" placeholder="코스모스" disabled>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">이메일</label>
                    <input type="email" class="form-control" id="email" placeholder="이메일 주소" disabled>
                </div>
                <div class="mb-3">
                    <label for="housingStatus" class="form-label">현재 주택 보유 여부</label>
                    <select class="form-select" id="housingStatus" required>
                        <option value="">선택해주세요</option>
                        <option value="0">무주택</option>
                        <option value="1">1주택</option>
                        <option value="2">2주택 이상</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="annualIncome" class="form-label">연간 소득</label>
                    <input type="text" class="form-control" id="annualIncome" placeholder="예) 50,000,000원" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">직업</label>
                    <div class="btn-group d-flex flex-wrap" role="group" aria-label="직업 선택">
                        <input type="radio" class="btn-check" name="occupation" id="occupation1" value="직장인" autocomplete="off">
                        <label class="btn btn-outline-primary mb-2 me-2" for="occupation1">직장인</label>

                        <input type="radio" class="btn-check" name="occupation" id="occupation2" value="개인사업자" autocomplete="off">
                        <label class="btn btn-outline-primary mb-2 me-2" for="occupation2">개인사업자</label>

                        <input type="radio" class="btn-check" name="occupation" id="occupation3" value="임대사업자" autocomplete="off">
                        <label class="btn btn-outline-primary mb-2 me-2" for="occupation3">임대사업자</label>

                        <input type="radio" class="btn-check" name="occupation" id="occupation4" value="공무원" autocomplete="off">
                        <label class="btn btn-outline-primary mb-2 me-2" for="occupation4">공무원</label>

                        <input type="radio" class="btn-check" name="occupation" id="occupation5" value="프리랜서/아르바이트" autocomplete="off">
                        <label class="btn btn-outline-primary mb-2 me-2" for="occupation5">프리랜서/아르바이트</label>

                        <input type="radio" class="btn-check" name="occupation" id="occupation6" value="무직(주부, 학생 등)" autocomplete="off">
                        <label class="btn btn-outline-primary mb-2 me-2" for="occupation6">무직(주부, 학생 등)</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="employmentDate" class="form-label">입사 연월</label>
                    <input type="month" class="form-control" id="employmentDate" required>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" id="saveBtn" class="btn btn-primary">저장하기</button>
                    <!-- 탈퇴하기 버튼 -->
<!--                    <button type="button" class="btn btn-outline-danger" id="deleteAccountButton" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">-->
<!--                        탈퇴하기-->
<!--                    </button>-->
                </div>
            </form>
        </div>
    </div>

    <!-- 탈퇴 확인 모달 -->
<!--    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">-->
<!--        <div class="modal-dialog modal-dialog-centered">-->
<!--            <div class="modal-content">-->
<!--                <div class="modal-header">-->
<!--                    <h5 class="modal-title" id="confirmDeleteModalLabel">탈퇴 확인</h5>-->
<!--                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--                </div>-->
<!--                <div class="modal-body">-->
<!--                    정말 탈퇴하시겠습니까? 탈퇴하면 계정 복구가 불가능합니다.-->
<!--                </div>-->
<!--                <div class="modal-footer">-->
<!--                    &lt;!&ndash; "아니오" 버튼 &ndash;&gt;-->
<!--                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button>-->
<!--                    &lt;!&ndash; "예" 버튼 &ndash;&gt;-->
<!--                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">예</button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

</div>

<!--footer-->
<footer th:replace="fragments/footer :: footer"></footer>

<!--Javascript-->
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- 사용자 정의 JS -->
<script th:src="@{/js/home.js}"></script>
<th:block th:replace="fragments/header :: scripts"></th:block>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // "예" 버튼 클릭 이벤트
        // const confirmDeleteButton = document.getElementById("confirmDeleteButton");
        // confirmDeleteButton.addEventListener("click", function () {
        //     // 테스트용으로 간단한 알림과 로그
        //     console.log("사용자가 탈퇴를 확인했습니다.");
        //     alert("탈퇴가 완료되었습니다.");
        //
        //     // 모달 닫기
        //     const modal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
        //     modal.hide();
        //
        //     // 탈퇴 이후 로직 (예: 메인 페이지로 리디렉션)
        //     // window.location.href = "/"; // 메인 페이지로 이동
        // });
        //
        // // "아니오" 버튼 클릭 이벤트
        // const cancelButton = document.querySelector(".btn-secondary"); // "아니오" 버튼 선택
        // cancelButton.addEventListener("click", function () {
        //     // 모달 닫기
        //     const modal = bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal"));
        //     modal.hide();
        //     console.log("사용자가 탈퇴를 취소했습니다."); // 테스트용 로그
        // });


        // REST API로부터 사용자 데이터를 가져오는 함수
        async function fetchUserData() {
            try {
                const response = await fetch('/user/my-info-page');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const userData = await response.json();
                populateUserInfo(userData);
            } catch (error) {
                console.error('There was a problem fetching user data:', error);
            }
        }

        // 가져온 데이터를 HTML에 반영하는 함수
        function populateUserInfo(user) {

            document.getElementById('name').value = user.name;
            document.getElementById('email').value = user.email;
            document.getElementById('housingStatus').value = user.houseNum;
            document.getElementById('annualIncome').value = user.annualIncome;
            document.getElementById('employmentDate').value = user.jobDate.substring(0, 7); // yyyy-MM 형태로 변환

            // 직업 라디오 버튼 선택 처리
            const occupationRadios = document.getElementsByName('occupation');
            occupationRadios.forEach(radio => {
                if (radio.value === user.job) {
                    radio.checked = true;
                }
            });
        }

        // 저장 버튼 클릭 시 서버로 업데이트 요청을 보내는 함수
        document.getElementById('saveBtn').addEventListener('click', async () => {

            const houseNumMap = {
                '0': 0,
                '1': 1,
                '2': 2
            };

            const annualIncomeStr = document.getElementById('annualIncome').value;
            const annualIncome = parseInt(annualIncomeStr.replace(/,|원/g, ''));

            const updateDto = {
                houseNum: houseNumMap[document.getElementById('housingStatus').value],
                annualIncome: annualIncome,
                job: document.querySelector('input[name="occupation"]:checked').value,
                jobDate: document.getElementById('employmentDate').value + '-01',
                addInfo: true
            };

            try {
                const response = await fetch('/user/update-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateDto)
                });

                if (response.ok) {
                    alert('추가 정보가 성공적으로 저장되었습니다.');
                    window.location.href = '/';
                } else {
                    alert('정보 저장에 실패했습니다. 다시 시도해주세요.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('서버 오류가 발생했습니다.');
            }
        });

        // 데이터 로드 시작
        fetchUserData();
    });
</script>
</body>
</html>