<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-tagsinput@0.8.0/dist/bootstrap-tagsinput.css" rel="stylesheet">
    <!-- 사용자 정의 CSS -->
    <link rel="stylesheet" href="/css/common.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMsWx9Kp3yYfRvH+8abtTE1Pi6jizoFj/6U24xg" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .box {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 45px;
            margin-bottom: 20px;
        }
        /* 최근 조회 버튼 */
        .btn-custom {
            border: 1px solid #007bff;
            color: #007bff;
            background-color: transparent;
        }
        /* 시장지표 */
        .indicator-box {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .indicator-item {
            text-align: center;
            padding: 15px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .indicator-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .indicator-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .indicator-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .indicator-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .indicator-sub {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .indicator-icon {
            font-size: 3rem;
            margin-top: 10px;
        }

        @media (max-width: 992px) {
            .indicator-item {
                margin-bottom: 20px;
            }
        }

        @media (max-width: 768px) {
            .indicator-value {
                font-size: 1.5rem;
            }
        }
        /* 아파트 정보 */
        .apt-env-card {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* 상단부터 시작 */
            align-items: center;
            text-align: center;
            position: relative; /* 상대 위치 지정 */
            margin: 0;
            padding-top: 15px;
            font-size: 0.8rem;
        }

        .apt-env-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff4081, #81d4fa);
            border-radius: 20%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px; /* 아이콘과 텍스트 사이의 간격 */
        }

        .apt-env-icon i {
            font-size: 30px;
            color: white;
        }

        .apt-env-item-title {
            color: #006fe6;
            font-weight: bold;
        }

        .apt-env-item-content {
            color: gray;
        }

        .apt-price {
            font-family: Arial, sans-serif;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .price-index {
            font-weight: bold;
            color: #333;
        }

        .price-value {
            color: #007bff;
        }

        .price-date, .price-percentage {
            font-size: 0.8em;
            color: #6c757d;
            margin-left: 5px;
        }
        .table {
            font-size: 0.9rem;
        }
        /* 대출 시뮬레이션 */
        .loan-simulation {
            border-radius: 10px;
        }
        .loan-simulation .card {
            border-color: transparent;
        }
        .slider-container {
            width: 100%;
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, #285fa7, #dc3545);
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid gray;
            background: #ffffff;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid gray;
            background: #ffffff;
            cursor: pointer;
        }
        .slider-wrapper {
            position: relative;
            padding-top: 20px;
        }

        .slider-label {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: transparent;
            color: gray;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        /*.slider-labels {*/
        /*    color: #6c757d;*/
        /*    font-size: 0.8rem;*/
        /*}*/
        /**/

        .tag-cloud-ad, .tag-cloud-dis {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .tag:hover {
            transform: scale(1.1);
        }
        .tag-blue { background-color: #e0f7fa; color: #007bff; }
        .tag-orange { background-color: #ffe0b2; color: #ff5722; }
        .tag-yellow { background-color: #fff9c4; color: #fbc02d; }
        .tag-green { background-color: #c8e6c9; color: #388e3c; }
        .tag-purple { background-color: #e1bee7; color: #8e24aa; }
        .tag-red { background-color: #ffcdd2; color: #e53935; }

        .content-header {
            height: 50px
        }
        .content-box {
            height: 200px;
        }
        .ratio-box {
            height: 140px;
        }
        .chart-box {
            height: 300px;
        }
        .table-box {
            height: auto;
        }
        .large-box {
            height: 150px;
        }
        /* 기본 링크 스타일 */
        .article-link {
            color: black; /* 기본 텍스트 색상 */
            font-weight: bold; /* 굵은 글씨체 */
            text-decoration: none; /* 밑줄 제거 */
            transition: color 0.3s ease, text-decoration 0.3s ease; /* 부드러운 전환 효과 */
        }
        /* 호버 시 스타일 */
        .article-link:hover {
            color: #007bff; /* 호버 시 색상 변경 (파란색 예시) */
            text-decoration: underline; /* 밑줄 추가 */
        }
        /* td 기본 스타일: 가운데 정렬 */
        td.align-middle {
            vertical-align: middle; /* 세로 가운데 정렬 */
        }
    </style>
</head>
<body>

<!--헤더-->
<header th:replace="fragments/header :: nav"></header>

<!--본문-->
<div class="content-wrapper">
    <!--본문 내용 입력하기-->
    <div class="container mt-4">
        <!--최근 조회내역 버튼-->
        <div class="row">
            <div class="d-flex justify-content-start flex-wrap mb-3">
                <div class="me-3">
                    <button type="button" class="btn btn-outline-primary btn-custom">상암IT타워</button>
                </div>
                <div class="me-3">
                    <button type="button" class="btn btn-outline-primary btn-custom">상암월드컵경기장</button>
                </div>
                <div class="me-3">
                    <button type="button" class="btn btn-outline-primary btn-custom">트리마제</button>
                </div>
            </div>
        </div>
        <!--부동산 지표들-->
        <div class="row">
            <div class="col-12">
                <div class="box indicator-box">
                    <div class="row g-4">
                        <div class="col">
                            <div class="indicator-item">
                                <p class="indicator-label">시장 지표</p>
                                <h5 class="indicator-title">CD 금리</h5>
                                <h3 class="indicator-value text-primary">4.56%</h3>
                                <p class="indicator-sub">전일 상품지수 126,000원</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="indicator-item">
                                <p class="indicator-label">시장 지표</p>
                                <h5 class="indicator-title">코픽스</h5>
                                <h3 class="indicator-value text-primary">4.56%</h3>
                                <p class="indicator-sub">전일 상품지수 126,000원</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="indicator-item">
                                <p class="indicator-label">시장 지표</p>
                                <h5 class="indicator-title">금융채 5년</h5>
                                <h3 class="indicator-value text-primary">4.56%</h3>
                                <p class="indicator-sub">전일 상품지수 126,000원</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="indicator-item">
                                <p class="indicator-label">시장 지표</p>
                                <h5 class="indicator-title">부동산 매매거래지수</h5>
                                <h3 class="indicator-value text-primary">4.56%</h3>
                                <p class="indicator-sub">전일 상품지수 126,000원</p>
                            </div>
                        </div>
                        <div class="col">
                            <div class="indicator-item">
                                <p class="indicator-label" th:text="${neighborhood}"></p>
                                <h2 class="indicator-title">부동산 날씨</h2>
                                    <div id="weatherIcon" style="font-size: 35px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 아파트 이름 -->
        <div class="row">
            <div class="col-12">
                <div class="box apt-name d-flex flex-column justify-content-center bg-primary text-white p-3">
                    <h3 class="mt-2 ms-2 fw-semibold" th:text="${apartment != null ? apartment : '아파트 정보 없음'}"></h3>
                    <h6 class="ms-2" th:text="${city != null and district != null and neighborhood != null ?
      city + ' ' + district + ' ' + neighborhood : '주소 정보 없음'}"></h6>
                </div>
            </div>
        </div>
        <!--아파트정보 & 아파트실거래 차트-->
        <div class="row d-flex align-items-stretch">
            <!-- 아파트 정보 -->
            <div class="col-6 d-flex flex-column">
                <!-- 아파트 상세 정보 -->
                <div class="box apt-info">
                    <div class="apt-details text-center pb-4">
                        <div class="my-2">아파트 | 매매 | 전용 <span id="squareMeters">235.31</span>m² (<span id="pyeong"></span>평)</div>
                        <div class="my-2">최고 <span th:text="${basicInfo.kaptTopFloor}"></span>층 | <span th:text="${basicInfo.kaptDongCnt}"></span>개 동 | <span th:text="${basicInfo.kaptdaCnt}"></span>세대</div>
                        <div class="my-2">전용 면적별 세대 현황<br>
                            60㎡ 이하 <span th:text="${basicInfo.kaptMparea_60}"></span> 세대 |
                            60㎡~85㎡ 이하 <span th:text="${basicInfo.kaptMparea_85}"></span> 세대 |<br>
                            85㎡~135㎡ 이하 <span th:text="${basicInfo.kaptMparea_135}"></span> 세대 |
                            135㎡ 초과 <span th:text="${basicInfo.kaptMparea_136}"></span> 세대
                        </div>
                    </div>
                    <!-- 아파트 가격정보 -->
                    <div class="apt-content">
                        <div class="apt-price">
                            <div class="price-row">
                                <div class="price-index">
                                    이전 실거래가
                                    <span class="price-date">(2022.05.16)</span>
                                </div>
                                <div class="price-value" data-price="8350000000"></div>
                            </div>
                            <div class="price-row">
                                <div class="price-index">
                                    최근 실거래가
                                    <span class="price-date">(2024.09.30)</span>
                                </div>
                                <div class="price-value" data-price="10600000000"></div>
                            </div>
                            <div class="price-row">
                                <div class="price-index">증가율</div>
                                <div class="price-value" id="price-increase"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--아파트 실거래 차트-->
            <div class="col-6 d-flex flex-column">
                <div class="box flex-fill d-flex flex-column justify-content-center align-items-center">
                    <div class="row d-flex align-items-center w-100">
                        <h5>아파트 실거래 차트</h5>
                        <canvas id="apartmentPriceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row d-flex align-items-stretch">
            <!--아파트 환경 정보-->
            <div class="col-6 d-flex flex-column">
                <div class="box container">
                    <div class="row justify-content-center">
                        <!-- 첫 번째 행 -->
                        <div class="row">
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-car-front-fill"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">주차 대수</div>
                                    <div class="apt-env-item-content">지상 <span th:text="${detailInfo.kaptdPcnt}"></span>대<br>지하 <span th:text="${detailInfo.kaptdPcntu}"></span>대</div>
                                </div>
                            </div>
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-bus-front-fill"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">버스정류장과의 거리</div>
                                    <div class="apt-env-item-content"><span th:text="${detailInfo.kaptdWtimebus}"></span></div>
                                </div>
                            </div>
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-walking"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">지하철역과의 거리</div>
                                    <div class="apt-env-item-content"><span th:text="${detailInfo.kaptdWtimesub}"></span></div>
                                </div>
                            </div>
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-subway"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">가까운 지하철</div>
                                    <div class="apt-env-item-content">
                                        <span th:text="${detailInfo.subwayLine}"></span><br>
                                        <span th:text="${detailInfo.subwayStation}"></span></div>
                                </div>
                            </div>
                        </div>
                        <!-- 두 번째 행 -->
                        <div class="row">
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-ev-station-fill"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">전기차 충전</div>
                                    <div class="apt-env-item-content">
                                        지상 <span th:text="${detailInfo.groundElChargerCnt}"></span>대<br>
                                        지하 <span th:text="${detailInfo.undergroundElChargerCnt}"></span>대
                                    </div>
                                </div>
                            </div>
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-shop"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">편의시설</div>
                                    <div class="apt-env-item-content"><span th:text="${detailInfo.convenientFacility}"></span></div>
                                </div>
                            </div>
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-book-half"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">가까운 학교</div>
                                    <div class="apt-env-item-content"><span th:text="${detailInfo.educationFacility}"></span></div>
                                </div>
                            </div>
                            <div class="apt-env-card col-3">
                                <div class="apt-env-icon">
                                    <i class="bi bi-building"></i>
                                </div>
                                <div class="apt-env-item">
                                    <div class="apt-env-item-title">부대시설</div>
                                    <div class="apt-env-item-content"><span th:text="${detailInfo.welfareFacility}"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div >
            </div>
            <!--아파트 실거래 표-->
            <div class="col-6 d-flex flex-column">
                <div class="box flex-fill d-flex flex-column justify-content-center align-items-center">
                    <div class="row d-flex align-items-center w-100">
                        <h5 th:text="${apartment + ' 실거래 매매 정보'}"></h5>
                        <div class="container">
                            <div style="overflow-y: auto;">
                                <table id="MyAptTable" class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>층</th>
                                        <th>건축년도</th>
                                    </tr>
                                    </thead>
                                    <tbody id="myAptTableBody">
                                    <!-- 데이터가 여기에 동적으로 추가됩니다 -->
                                    </tbody>
                                </table>
                            </div>
                            <button id="loadMoreBtn2" class="btn btn-primary mt-3">더보기</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--대출 시뮬레이션 & LTV/DTI/DSR-->
        <div class="row d-flex">
            <!-- 대출 시뮬레이션 -->
            <div class="col-8 d-flex flex-fill">
                <div class="box loan-simulation small flex-fill d-flex flex-column justify-content-center align-items-center">
                    <h5 class="mb-4 text-start w-100">대출 시뮬레이션</h5>
                    <div class="row w-100">
                        <div class="col-md-6">
                            <div class="card flex-fill">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold">총 필요 자금</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>실거래가</span>
                                        <strong id="totalAmount" class="text-end"></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>취득세</span>
                                        <strong id="acquisitionTax" class="text-end"></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>중개보수</span>
                                        <strong id="brokerageFee" class="text-end"></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>자본금</span>
                                        <strong id="equity" class="text-primary text-end"></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>대출금</span>
                                        <strong id="loan" class="text-primary text-end"></strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card flex-fill">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>대출 예상기간</span>
                                        <select id="loanPeriod" class="form-select form-select-sm" style="width: auto;">
                                            <option value="5">5년</option>
                                            <option value="10" selected>10년</option>
                                            <option value="15">15년</option>
                                            <option value="20">20년</option>
                                            <option value="25">25년</option>
                                            <option value="30">30년</option>
                                            <option value="35">35년</option>
                                            <option value="40">40년</option>
                                            <option value="45">45년</option>
                                            <option value="50">50년</option>
                                        </select>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>대출 예상비용</span>
                                        <span id="monthlyPayment" class="text-primary text-end"></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>연간 예상비용</span>
                                        <span id="annualPayment" class="text-primary text-end"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="slider-container mt-4">
                        <div class="slider-wrapper">
                            <input type="range" id="loanSlider" min="0" value="0" class="slider">
                            <span id="midLabel" class="slider-label">50%</span>
                        </div>
                        <div class="slider-labels d-flex justify-content-between mt-2">
                            <span>0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- LTV, DTI, DSR 그래프 -->
            <div class="col-4 d-flex flex-column flex-fill">
                <div class="box ratio-box mb-1 flex-fill d-flex flex-column justify-content-center align-items-center">
                    <h6>LTV</h6>
                    <canvas id="ltvChart" class="d-flex"></canvas>
                </div>
                <div class="box ratio-box mb-1 flex-fill d-flex flex-column justify-content-center align-items-center mt-3">
                    <h6>DTI</h6>
                </div>
                <div class="box ratio-box flex-fill d-flex flex-column justify-content-center align-items-center mt-3">
                    <h6>DSR(스트레스 DSR?)</h6>
                </div>
            </div>
        </div>

        <!--지역구 아파트 실거래 정보-->
        <div class="row d-flex flex-fill">
                <!-- 지역구 실거래 표 -->
                <div class="col-6 d-flex flex-column flex-fill">
                    <div class="box flex-fill d-flex flex-column">
                        <h5 th:text="${city + ' ' + district + ' ' + neighborhood + ' 실거래 매매 정보'}"></h5>
                        <div class="container flex-fill">
                            <div style="max-height: 250px; overflow-y: auto;">
                                <table id="LocalAptTable" class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>거래일</th>
                                        <th>아파트명</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>층</th>
                                        <th>건축년도</th>
                                    </tr>
                                    </thead>
                                    <tbody id="aptTableBody">
                                    <!-- 데이터가 여기에 동적으로 추가됩니다 -->
                                    </tbody>
                                </table>
                            </div>
                            <button id="loadMoreBtn" class="btn btn-primary mt-3">더보기</button>
                        </div>
                    </div>
                </div>
                <!-- 지역구 실거래 차트 -->
                <div class="col-6 d-flex flex-column flex-fill">
                    <div class="box flex-fill d-flex flex-column">
                        <h5>월평균 실거래 가격 차트</h5>
                        <canvas id="monthlyPriceScatterChart" class="flex-fill"></canvas>
                    </div>
                </div>
            </div>

        <!--지역구 부동산 기사-->
        <div class="row d-flex flex-fill">
            <!-- 지역구 부동산 기사 -->
            <div class="col-6 d-flex flex-column flex-fill">
                <div class="box flex-fill">
                    <h5 class="mb-4">우리동네 부동산 기사</h5>
                    <div th:if="${newsError}" class="alert alert-danger" th:text="${newsError}"></div>
                    <div th:unless="${newsError}" class="news-list" style="overflow-y: auto;">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th style="width: 10%;">감정</th>
                                <th style="width: 70%;">제목</th>
                                <th style="width: 20%;">정보</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="article : ${newsArticles}">
                                <!-- 감정 열 -->
                                <td class="align-middle">
                                    <img th:if="${article.sentiment == '긍정'}"
                                         src="/img/planet_good.png" alt="긍정" style="width: 20px; height: 20px;">
                                    <img th:if="${article.sentiment == '부정'}"
                                         src="/img/planet_bad.png" alt="부정" style="width: 20px; height: 20px;">
                                    <!-- 중립인 경우 이미지를 표시하지 않음 -->
                                </td>
                                <!-- 제목 열 -->
                                <td class="align-middle">
                                    <a th:href="${article.url}" target="_blank"
                                       class="article-link" style="text-decoration: none;"
                                       th:text="${article.title}"></a>
                                </td>
                                <!-- 회사 및 날짜 정보 열 -->
                                <td>
                                    <div class="d-flex flex-column">
                                        <small class="text-muted" th:text="${article.company}"></small>
                                        <small class="text-muted" th:text="${article.articleDate}"></small>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- 지역구 부동산 기사 워드 클라우드 -->
            <div class="col-6 d-flex flex-column flex-fill">
                <div class="box flex-fill">
                    <h5 class="mb-4">키워드 워드 클라우드</h5>
                    <div id="wordCloud" style="height: 600px;"></div>
                </div>
            </div>
        </div>

        <!--아파트 단지 리뷰-->
        <div class="row d-flex flex-fill">
            <!-- 우리 아파트 단지 장점 -->
            <div class="col-6 d-flex flex-column flex-fill">
                <div class="box flex-fill d-flex flex-column">
                    <h5 class="text-start">우리 아파트의 장점</h5>
                    <div class="tag-cloud flex-fill d-flex justify-content-center align-items-center">
                        <div class="tag-cloud-ad" id="advantageCloud">
                            <!-- 태그들은 JavaScript로 동적으로 생성됩니다 -->
                        </div>
                    </div>
                    <div class="container mt-3">
                        <select class="form-select" id="apartmentAdvantages" name="apartmentAdvantages[]" multiple data-allow-clear="true" data-suggestions-threshold="0" style="display: none;">
                            <option value="조용해요">조용해요</option>
                            <option value="교통이 편리해요">교통이 편리해요</option>
                            <option value="주차가 편리해요">주차가 편리해요</option>
                            <option value="보안이 좋아요">보안이 좋아요</option>
                            <option value="관리 상태가 좋아요">관리 상태가 좋아요</option>
                            <option value="이웃들이 좋아요">이웃들이 좋아요</option>
                            <option value="학군이 좋아요">학군이 좋아요</option>
                            <option value="커뮤니티 시설이 잘 되어 있어요">커뮤니티 시설이 잘 되어 있어요</option>
                            <option value="상가가 잘 되어 있어요">상가가 잘 되어 있어요</option>
                            <option value="단지 내 유치원/어린이집이 있어요">단지 내 유치원/어린이집이 있어요</option>
                            <option value="주변 의료 환경이 좋아요">주변 의료 환경이 좋아요</option>
                            <option value="근처에 맛집이 많아요">근처에 맛집이 많아요</option>
                            <option value="산책로/공원이 잘 되어 있어요">산책로/공원이 잘 되어 있어요</option>
                        </select>
                        <div class="d-flex flex-column align-items-center justify-content-center mt-3">
                            <div class="invalid-feedback text-center mb-2">장점을 하나 이상 선택해주세요.</div>
                            <button id="adButton" type="button" class="btn btn-outline-primary btn-custom col-12">추가하기</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 우리 아파트 단지 단점 -->
            <div class="col-6 d-flex flex-column flex-fill">
                <div class="box flex-fill d-flex flex-column">
                    <h5 class="text-start">우리 아파트의 단점</h5>
                    <div class="tag-cloud flex-fill d-flex justify-content-center align-items-center">
                        <div class="tag-cloud-dis" id="disadvantageCloud">
                            <!-- 태그들은 JavaScript로 동적으로 생성됩니다 -->
                        </div>
                    </div>
                    <div class="container mt-3">
                        <select class="form-select" id="apartmentDisadvantages" name="apartmentDisadvantages[]" multiple data-allow-clear="true" data-suggestions-threshold="0" style="display: none;">
                            <option value="소음">소음</option>
                            <option value="주차부족">주차부족</option>
                            <option value="관리비">관리비</option>
                            <option value="노후화">노후화</option>
                            <option value="교통불편">교통불편</option>
                            <option value="층간소음">층간소음</option>
                            <option value="편의시설부족">편의시설부족</option>
                            <option value="안전문제">안전문제</option>
                        </select>
                        <div class="d-flex flex-column align-items-center justify-content-center mt-3">
                            <div class="invalid-feedback text-center mb-2">단점을 하나 이상 선택해주세요.</div>
                            <button id="disButton" type="button" class="btn btn-outline-danger btn-custom col-12">추가하기</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--footer-->
<footer th:replace="fragments/footer :: footer"></footer>

<!--Javascript-->
<!-- 사용자 정의 JS -->
<script th:src="@{/js/home.js}"></script>
<th:block th:replace="fragments/header :: scripts"></th:block>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!--아파트 환경정보-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.js"></script>

<!--차트-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>

<!--아파트 리뷰-->
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- anychart 라이브러리 추가 -->
<script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-tag-cloud.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function formatNumber(number) {
            return new Intl.NumberFormat('ko-KR').format(number);
        }

        function convertToKorean(number) {
            const units = ['', '만', '억', '조'];
            let result = '';
            let unitIndex = 0;
            while (number > 0) {
                let part = number % 10000;
                if (part > 0) {
                    result = formatNumber(part) + units[unitIndex] + ' ' + result;
                }
                number = Math.floor(number / 10000);
                unitIndex++;
            }
            return result.trim() + '원';
        }

        function updatePrices() {
            const priceValues = document.querySelectorAll('.price-value');
            priceValues.forEach(function(element) {
                if (element.dataset.price) {
                    const price = parseInt(element.dataset.price);
                    element.textContent = convertToKorean(price);
                }
            });

            // 증가율 계산
            const previousPrice = parseInt(priceValues[0].dataset.price);
            const recentPrice = parseInt(priceValues[1].dataset.price);
            const increase = recentPrice - previousPrice;
            const increasePercentage = ((increase / previousPrice) * 100).toFixed(2);

            const priceIncrease = document.getElementById('price-increase');
            priceIncrease.innerHTML = `
            <span class="price-percentage">(${increasePercentage > 0 ? '+' : '-'}${increasePercentage}%)</span>
            ${convertToKorean(Math.abs(increase))}`;
        }

        // Chart.js를 사용한 LTV 차트 생성
        let ltvChart;

        function updateLTVChart() {
            const loanElement = document.getElementById('loan');
            const totalAmountElement = document.getElementById('totalAmount');

            if (!loanElement || !totalAmountElement) {
                console.error('Loan or Total Amount element not found');
                return;
            }

            const loan = parseInt(loanElement.textContent.replace(/[^0-9]/g, ''));
            const totalAmount = parseInt(totalAmountElement.textContent.replace(/[^0-9]/g, ''));

            if (isNaN(loan) || isNaN(totalAmount) || totalAmount === 0) {
                console.error('Invalid loan or total amount values');
                return;
            }

            const ltv = (loan / totalAmount) * 100;

            const ctx = document.getElementById('ltvChart');
            if (!ctx) {
                console.error('LTV Chart canvas not found');
                return;
            }

            if (ltvChart) {
                ltvChart.data.datasets[0].data = [ltv, 100 - ltv];
                ltvChart.options.plugins.tooltip.callbacks.label = (context) => `${context.parsed.toFixed(1)}%`;
                ltvChart.update('none'); // 애니메이션 없이 즉시 업데이트
            } else {
                ltvChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [ltv, 100 - ltv],
                            backgroundColor: ['#007bff', '#e9ecef'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        rotation: -90,
                        circumference: 180,
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 차트 중앙에 LTV 값 표시
            const ltvText = document.getElementById('ltvText');
            if (ltvText) {
                ltvText.textContent = ltv.toFixed(1) + '%';
            }
        }

        function updateLoanInfo() {
            const slider = document.getElementById('loanSlider');
            const totalAmount = parseInt(document.querySelectorAll('.price-value[data-price]')[1].dataset.price);
            const loanPeriod = parseInt(document.getElementById('loanPeriod').value);

            // 5천만원 단위로 자본금 계산
            const equityStep = 50000000; // 5천만원
            const maxSteps = Math.floor(totalAmount / equityStep);

            slider.max = maxSteps; // 슬라이더의 최대값을 조정

            const currentStep = parseInt(slider.value);
            const equity = currentStep * equityStep;
            const loan = totalAmount - equity;

            document.getElementById('totalAmount').textContent = convertToKorean(totalAmount);
            document.getElementById('equity').textContent = convertToKorean(equity);
            document.getElementById('loan').textContent = convertToKorean(loan);

            // 취득세와 중개보수 계산 (예시 - 실제 계산 방식에 따라 조정 필요)
            const acquisitionTax = Math.round(totalAmount * 0.04);
            const brokerageFee = Math.round(totalAmount * 0.005);

            document.getElementById('acquisitionTax').textContent = convertToKorean(acquisitionTax);
            document.getElementById('brokerageFee').textContent = convertToKorean(brokerageFee);

            // 대출 예상 비용 계산
            const monthlyInterestRate = 0.0375 / 12; // 연 3.75% 이자율 가정
            const numberOfPayments = loanPeriod * 12; // 선택된 대출 기간
            const monthlyPayment = Math.round((loan * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1));

            document.getElementById('monthlyPayment').textContent = '매월 ' + convertToKorean(monthlyPayment);
            document.getElementById('annualPayment').textContent = '연간 ' + convertToKorean(monthlyPayment * 12);

            updateLTVChart();
            updateSliderLabels();
        }

        function updateSliderLabels() {
            const slider = document.getElementById('loanSlider');
            const midLabel = document.getElementById('midLabel');
            const percentage = (slider.value / slider.max * 100).toFixed(0);
            midLabel.textContent = percentage + '%';

            // 레이블 위치 업데이트
            const sliderRect = slider.getBoundingClientRect();
            const thumbPosition = (slider.value / slider.max) * sliderRect.width;
            midLabel.style.left = `${thumbPosition}px`;
            midLabel.style.transform = 'translateX(-50%)';
        }

        function createApartmentPriceChart() {
            const ctx = document.getElementById('apartmentPriceChart').getContext('2d');
            // 데이터 준비 및 차트 생성 코드
        }

        // 평단가 계산
        const squareMeters = parseFloat(document.getElementById('squareMeters').textContent);
        const pyeong = squareMeters * 0.3025;
        const roundedPyeong = Math.round(pyeong * 100) / 100;
        document.getElementById('pyeong').textContent = roundedPyeong;

        // 초기 정보 업데이트 및 차트 생성
        updatePrices();
        updateLoanInfo();
        updateSliderLabels();
        createApartmentPriceChart();

        // 슬라이더 이벤트 리스너 설정 (디바운싱 적용)
        const slider = document.getElementById('loanSlider');
        let debounceTimer;
        slider.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateLoanInfo();
            }, 10);
            updateSliderLabels(); // 레이블 위치는 즉시 업데이트
        });

        // 대출 기간 선택 이벤트 리스너 설정
        const loanPeriodSelect = document.getElementById('loanPeriod');
        loanPeriodSelect.addEventListener('change', updateLoanInfo);

        // 윈도우 리사이즈 시 레이블 위치 조정
        window.addEventListener('resize', updateSliderLabels);
    });

</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        function formatNumber(number) {
            return new Intl.NumberFormat('ko-KR').format(number);
        }

        function convertToKorean(priceString) {
            let number = parseInt(priceString.replace(/,/g, '').replace('만원', '')) * 10000;
            const units = ['', '만', '억', '조'];
            let result = '';
            let unitIndex = 0;

            while (number > 0) {
                let part = number % 10000;
                if (part > 0) {
                    result = formatNumber(part) + units[unitIndex] + ' ' + result;
                }
                number = Math.floor(number / 10000);
                unitIndex++;
            }

            return result.trim() + '원';
        }

        // 데이터 준비
        const localItems = /*[[${items}]]*/ [];
        const lawdCode = /*[[${lawdCode}]]*/ '';
        const apartment = /*[[${apartment}]]*/ '';
        let localCurrentIndex = 0;
        const localItemsPerPage = 10;
        let myAptCurrentIndex = 0;
        const myAptItemsPerPage = 10;

        function loadMoreLocalItems() {
            const tableBody = document.getElementById('aptTableBody');
            if (!tableBody) return;

            // 필터링된 항목 가져오기
            let filteredItems = localItems.filter(item =>
                item.sggCd.startsWith(lawdCode.slice(0, 5)) &&
                item.umdCd.startsWith(lawdCode.slice(5, 10))
            );

            // 날짜 기준 최신순 정렬
            filteredItems.sort((a, b) => {
                const dateA = new Date(a.dealYear, a.dealMonth - 1, a.dealDay); // JS의 month는 0부터 시작
                const dateB = new Date(b.dealYear, b.dealMonth - 1, b.dealDay);
                return dateB - dateA; // 최신순
            });

            // 페이징 처리
            const endIndex = Math.min(localCurrentIndex + localItemsPerPage, filteredItems.length);

            for (let i = localCurrentIndex; i < endIndex; i++) {
                const item = filteredItems[i];
                const row = tableBody.insertRow();
                row.innerHTML = `
            <td>${item.dealYear}년 ${item.dealMonth}월 ${item.dealDay}일</td>
            <td>${item.aptNm}</td>
            <td>${convertToKorean(item.dealAmount)}</td>
            <td>${item.excluUseAr}m²</td>
            <td>${item.floor}층</td>
            <td>${item.buildYear}년</td>
        `;
            }

            localCurrentIndex = endIndex;

            // "더보기" 버튼 상태 업데이트
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = localCurrentIndex >= filteredItems.length ? 'none' : 'block';
            }
        }

        function loadMoreMyAptItems() {
            const tableBody = document.getElementById('myAptTableBody');
            if (!tableBody) return;

            // 현재 아파트 데이터 필터링 및 날짜 기준 최신순 정렬
            const filteredItems = localItems
                .filter(item => item.aptNm === apartment)
                .sort((a, b) => {
                    const dateA = new Date(a.dealYear, a.dealMonth - 1, a.dealDay); // JS에서 month는 0부터 시작
                    const dateB = new Date(b.dealYear, b.dealMonth - 1, b.dealDay);
                    return dateB - dateA; // 최신순 정렬
                });

            let count = 0;

            // 페이징 처리
            while (count < myAptItemsPerPage && myAptCurrentIndex < filteredItems.length) {
                const item = filteredItems[myAptCurrentIndex];
                const row = tableBody.insertRow();
                const koreanPrice = convertToKorean(item.dealAmount);
                row.innerHTML = `
            <td>${item.dealYear}년 ${item.dealMonth}월 ${item.dealDay}일</td>
            <td>${koreanPrice}</td>
            <td>${item.excluUseAr}m²</td>
            <td>${item.floor}층</td>
            <td>${item.buildYear}년</td>
        `;
                count++;
                myAptCurrentIndex++;
            }

            // "더보기" 버튼 상태 업데이트
            const loadMoreBtn = document.getElementById('loadMoreBtn2');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = myAptCurrentIndex >= filteredItems.length ? 'none' : 'block';
            }
        }

        function createApartmentPriceChart() {
            const ctx = document.getElementById('apartmentPriceChart');
            if (!ctx) return;

            const data = localItems
                .filter(item => item.aptNm === apartment)
                .map(item => ({
                    date: `${item.dealYear}-${String(item.dealMonth).padStart(2, '0')}-${String(item.dealDay).padStart(2, '0')}`,
                    price: parseInt(item.dealAmount.replace(/,/g, '').replace('만원', '')) * 10000
                }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: '실거래가',
                        data: data.map(item => item.price / 100000000),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'YYYY-MM'
                                }
                            },
                            title: {
                                display: true,
                                text: '거래일'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '가격 (억 원)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '억';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyPriceScatterChart() {
            const ctx = document.getElementById('monthlyPriceScatterChart');
            if (!ctx) return;

            // 데이터 준비
            const scatterData = localItems.map(item => ({
                x: parseInt(item.dealMonth),
                y: parseInt(item.dealAmount.replace(/,/g, '').replace('만원', '')) * 10000 / 100000000 // 억 단위 변환
            }));

            // 차트 생성
            new Chart(ctx.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '월별 거래 가격 (억 원)',
                        data: scatterData,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            min: 1,
                            max: 12,
                            title: {
                                display: true,
                                text: '월'
                            },
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + '월';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '거래 가격 (억 원)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '억';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return `${point.x}월: ${point.y.toFixed(2)}억 원`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 실행
        loadMoreLocalItems();
        loadMoreMyAptItems();
        createApartmentPriceChart();
        createMonthlyPriceScatterChart();
    });
    /*]]>*/
</script>
<script>
    $(document).ready(function() {
        var lawdCode = "[[${lawdCode}]]"; // Thymeleaf를 사용하여 lawdCode 값을 가져옵니다.
        $.get("/housing-weather", { lawdCode: lawdCode }, function(data) {
            $("#weatherIcon").text(data);
        });
    });
</script>
<!--아파트 리뷰-->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // kaptCode 변수 선언
        const kaptCode = /*[[${param.KaptCode}]]*/ null;
        let advantagesTagify, disadvantagesTagify;

        const advantagesList = ["조용해요", "교통이 편리해요", "주차가 편리해요", "보안이 좋아요",
            "관리 상태가 좋아요", "이웃들이 좋아요", "학군이 좋아요", "커뮤니티 시설이 잘 되어 있어요",
            "상가가 잘 되어 있어요", "단지 내 유치원/어린이집이 있어요", "주변 의료 환경이 좋아요",
            "근처에 맛집이 많아요", "산책로/공원이 잘 되어 있어요"];

        const disadvantagesList = ["소음이 많아요", "교통이 불편해요", "주차가 불편해요",
            "외부인 출입이 자유로워요", "노후된 부분이 많아요", "학교가 멀어요", "커뮤니티 시설이 없어요",
            "상가가 없어요", "단지 내 유치원/어린이집이 없어요", "주변 의료 환경이 불편해요",
            "식당이 멀어요", "근처에 산책로/공원이 없어요"];

        // Tagify 초기화 함수
        function initializeTagify(elementId, whitelist) {
            var input = document.getElementById(elementId);
            return new Tagify(input, {
                whitelist: whitelist,
                maxTags: 5,
                enforceWhitelist: true,
                dropdown: {
                    maxItems: 20,
                    classname: "tags-look",
                    enabled: 0,
                    closeOnSelect: false
                }
            });
        }

        // 태그 클라우드 초기화
        function initializeTagCloud(elementId, frequencies, colors) {
            const tagCloud = document.getElementById(elementId);
            const sortedTags = Object.entries(frequencies).sort((a, b) => b[1] - a[1]);
            const fontSizes = calculateFontSizes(frequencies);

            function createTags() {
                tagCloud.innerHTML = '';
                sortedTags.forEach(([tagText, freq], index) => {
                    const tag = document.createElement('span');
                    tag.textContent = '#' + tagText;
                    tag.className = `tag tag-${colors[index % colors.length]}`;
                    tag.style.fontSize = `${fontSizes[tagText].toFixed(2)}px`;
                    tagCloud.appendChild(tag);
                });
            }

            createTags();
            window.addEventListener('resize', createTags);
        }

        // 폰트 크기 계산
        function calculateFontSizes(frequencies) {
            const maxFreq = Math.max(...Object.values(frequencies));
            const minSize = 11;
            const maxSize = 20;
            return Object.fromEntries(
                Object.entries(frequencies).map(([key, value]) => [
                    key,
                    minSize + (value / maxFreq) * (maxSize - minSize)
                ])
            );
        }

        // 장점 버튼 클릭 핸들러
        function handleProsButton() {
            var invalidFeedback = document.querySelector('#apartmentAdvantages').nextElementSibling.querySelector('.invalid-feedback');

            if (!advantagesTagify || advantagesTagify.value.length === 0) {
                invalidFeedback.style.display = 'block';
                return;
            }

            invalidFeedback.style.display = 'none';
            const selectedTags = advantagesTagify.value.map(tag => tag.value);
            const formData = new FormData();

            formData.append('kaptCode', kaptCode);
            selectedTags.forEach(tag => formData.append('pros', tag));

            fetch('/apt-evaluation/pros', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('로그인이 필요한 서비스입니다.');
                            return;
                        }
                        throw new Error('Network response was not ok');
                    }
                    alert('장점이 성공적으로 저장되었습니다.');
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('장점 저장 중 오류가 발생했습니다.');
                });
        }

        // 단점 버튼 클릭 핸들러
        function handleConsButton() {
            var invalidFeedback = document.querySelector('#apartmentDisadvantages').nextElementSibling.querySelector('.invalid-feedback');

            if (!disadvantagesTagify || disadvantagesTagify.value.length === 0) {
                invalidFeedback.style.display = 'block';
                return;
            }

            invalidFeedback.style.display = 'none';
            const selectedTags = disadvantagesTagify.value.map(tag => tag.value);
            const formData = new FormData();

            formData.append('kaptCode', kaptCode);
            selectedTags.forEach(tag => formData.append('cons', tag));

            fetch('/apt-evaluation/cons', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('로그인이 필요한 서비스입니다.');
                            return;
                        }
                        throw new Error('Network response was not ok');
                    }
                    alert('단점이 성공적으로 저장되었습니다.');
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('단점 저장 중 오류가 발생했습니다.');
                });
        }

        // 버튼에 이벤트 리스너 등록
        document.getElementById('adButton').addEventListener('click', handleProsButton);
        document.getElementById('disButton').addEventListener('click', handleConsButton);

        // Thymeleaf로 전달받은 데이터
        const evaluationData = /*[[${evaluationData}]]*/ {prosCounts: {}, consCounts: {}};

        // 장점 데이터 변환
        let prosData = {};
        if (!evaluationData || !evaluationData.prosCounts) {
            // 데이터가 없을 경우 기본값 설정
            prosData = {
                '조용해요': 0,
                '교통이 편리해요': 0,
                '주차가 편리해요': 0,
                '보안이 좋아요': 0,
                '관리 상태가 좋아요': 0,
                '이웃들이 좋아요': 0,
                '학군이 좋아요': 0,
                '커뮤니티 시설이 잘 되어 있어요': 0,
                '상가가 잘 되어 있어요': 0,
                '단지 내 유치원/어린이집이 있어요': 0,
                '주변 의료 환경이 좋아요': 0,
                '근처에 맛집이 많아요': 0,
                '산책로/공원이 잘 되어 있어요': 0
            };
        } else {
            const prosDto = evaluationData.prosCounts;
            prosData['조용해요'] = prosDto.quietCount || 0;
            prosData['교통이 편리해요'] = prosDto.transportCount || 0;
            prosData['주차가 편리해요'] = prosDto.parkingCount || 0;
            prosData['보안이 좋아요'] = prosDto.securityCount || 0;
            prosData['관리 상태가 좋아요'] = prosDto.maintenanceCount || 0;
            prosData['이웃들이 좋아요'] = prosDto.neighborsCount || 0;
            prosData['학군이 좋아요'] = prosDto.schoolCount || 0;
            prosData['커뮤니티 시설이 잘 되어 있어요'] = prosDto.communityCount || 0;
            prosData['상가가 잘 되어 있어요'] = prosDto.commercialCount || 0;
            prosData['단지 내 유치원/어린이집이 있어요'] = prosDto.daycareCount || 0;
            prosData['주변 의료 환경이 좋아요'] = prosDto.medicalCount || 0;
            prosData['근처에 맛집이 많아요'] = prosDto.restaurantsCount || 0;
            prosData['산책로/공원이 잘 되어 있어요'] = prosDto.parksCount || 0;
        }

        // 단점 데이터 변환
        let consData = {};
        if (!evaluationData || !evaluationData.consCounts) {
            // 데이터가 없을 경우 기본값 설정
            consData = {
                '소음이 많아요': 0,
                '교통이 불편해요': 0,
                '주차가 불편해요': 0,
                '외부인 출입이 자유로워요': 0,
                '노후된 부분이 많아요': 0,
                '학교가 멀어요': 0,
                '커뮤니티 시설이 없어요': 0,
                '상가가 없어요': 0,
                '단지 내 유치원/어린이집이 없어요': 0,
                '주변 의료 환경이 불편해요': 0,
                '식당이 멀어요': 0,
                '근처에 산책로/공원이 없어요': 0
            };
        } else {
            const consDto = evaluationData.consCounts;
            consData['소음이 많아요'] = consDto.noiseCount || 0;
            consData['교통이 불편해요'] = consDto.badTransportCount || 0;
            consData['주차가 불편해요'] = consDto.badParkingCount || 0;
            consData['외부인 출입이 자유로워요'] = consDto.badSecurityCount || 0;
            consData['노후된 부분이 많아요'] = consDto.outdatedCount || 0;
            consData['학교가 멀어요'] = consDto.badSchoolCount || 0;
            consData['커뮤니티 시설이 없어요'] = consDto.badCommunityCount || 0;
            consData['상가가 없어요'] = consDto.badCommercialCount || 0;
            consData['단지 내 유치원/어린이집이 없어요'] = consDto.badDaycareCount || 0;
            consData['주변 의료 환경이 불편해요'] = consDto.badMedicalCount || 0;
            consData['식당이 멀어요'] = consDto.badRestaurantsCount || 0;
            consData['근처에 산책로/공원이 없어요'] = consDto.badParksCount || 0;
        }

        // 0인 값 제거
        Object.keys(prosData).forEach(key => {
            if (prosData[key] === 0) delete prosData[key];
        });

        Object.keys(consData).forEach(key => {
            if (consData[key] === 0) delete consData[key];
        });

        // 태그 클라우드 초기화
        initializeTagCloud('advantageCloud', prosData, ['blue', 'orange', 'yellow', 'green', 'purple', 'red']);
        initializeTagCloud('disadvantageCloud', consData, ['blue', 'orange', 'yellow', 'green', 'purple', 'red']);

        // 초기화 및 이벤트 리스너 등록
        advantagesTagify = initializeTagify('apartmentAdvantages', advantagesList);
        disadvantagesTagify = initializeTagify('apartmentDisadvantages', disadvantagesList);

        // 로그인 상태 확인 변수 추가
        const isLoggedIn = /*[[${session.user_id != null}]]*/ false;

        // 기존 평가 데이터 로드 - 로그인 상태일 때만 실행
        if (isLoggedIn) {
            fetch(`/apt-evaluation?kaptCode=${kaptCode}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('로그인이 필요합니다.');
                            return;
                        }
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        // 장점 데이터 처리
                        if (data.hasProsEvaluation && data.pros && data.pros.length > 0) {
                            advantagesTagify.addTags(data.pros);
                            document.getElementById('adButton').textContent = '수정하기';
                        }
                        // 단점 데이터 처리
                        if (data.hasConsEvaluation && data.cons && data.cons.length > 0) {
                            disadvantagesTagify.addTags(data.cons);
                            document.getElementById('disButton').textContent = '수정하기';
                        }
                    }
                })
                .catch(error => console.error('Error loading user evaluation:', error));
        } else {
            console.log('로그인이 필요한 기능입니다.');
            document.getElementById('adButton').title = '로그인이 필요한 서비스입니다.';
            document.getElementById('disButton').title = '로그인이 필요한 서비스입니다.';
        }

        const keywordFrequency = /*[[${keywordFrequency}]]*/ {};


        // 워드 클라우드 데이터 형식으로 변환
        const wordCloudData = Object.entries(keywordFrequency)
            .map(([text, value]) => ({ x: text, value }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 30);

        // anychart를 사용한 워드 클라우드 생성
        anychart.onDocumentReady(function() {
            var chart = anychart.tagCloud(wordCloudData);
            chart.angles([0]);
            chart.textSpacing(5);
            chart.container("wordCloud");
            chart.draw();
        });
    });
</script>
</body>
</html>