<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />
  <!-- 사용자 정의 CSS -->
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" th:href="@{/css/popup.css}">


    <style>
        body {
            background-color: #f8f9fa;
        }
        .box {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 45px;
            margin-bottom: 20px;
        }
        .icon {
            width: 50px;
            height: 50px;
            background-color: #e9ecef;
            border-radius: 50%;
        }
    </style>
</head>
<body>

<!--헤더-->
<header th:replace="fragments/header :: nav"></header>


<!--본문-->
<div class="content-wrapper">
    <div th:text="'주소 정보: ' + ${cityCode} + ' ' + ${cityText} + ' ' + ${districtCode} + ' ' + ${districtText}"></div>
    <div>입출금 계좌 총합: <span id="totalBalance" class="text-primary fw-bold">0원</span></div>
    <div>연소득 : 일단은 아래 사용자 input값으로 계산</div>
    <!-- 연소득은 DB에서 받아와야함 -->
    <!-- 일단은 아래 사용자 input값으로 계산 -->
    <!--    <div th:text="'연소득: ' + ${annualIncome}"></div>-->

    <div class="row">
        <div class="col-6 d-flex flex-column">
            <div class="box flex-fill">
                현재 내 자산을 기준으로 대출을 받으면<br>
                <span th:text="${cityText} + ' ' + ${districtText}"></span>에서<br>
                <p id="outputText"></p>
                매달 원리금분할상환 방식으로<br>
                부담하는 아파트를 추천해드릴게요.<br>
                * 대출 금리는

            </div>
            <div class="box flex-fill">
                <button class="btn btn-primary" onclick="openIncomePopup()">다른 지역에서 찾아보기</button>
                <div>
                    <label for="incomeInput">소득 (원):</label>
                    <input type="number" id="incomeInput" placeholder="50000000" min="0" step="1">
                </div>
                <div>
                    <label for="yearsInput">기간 (년):</label>
                    <input type="number" id="yearsInput" placeholder="20" min="1" step="1">
                </div>
                <div>
                    <label for="percentageInput">소득 비율 (%):</label>
                    <input type="number" id="percentageInput" placeholder="25" min="0" max="100" step="1">
                </div>
            </div>
        </div>
        <div class="col-6 d-flex flex-column">
            <div class="box flex-fill">
                <div class="mb-3">
                    PIR 지수 : KB아파트 PIR(24 3Q) - 서울 11.2,  경기 9, 인천 8.1<br>
    <!--                PIR 추천 아파트 가격: <span id="pirResult">0원</span><br> <span id="pirPrice">0원</span><br>-->
                    K-HAI 기준 적정부담액: 소득의 25.7% 이하를 원리금분할상환으로 부담할 때<br>
    <!--                K-HAI 지수(대출금리 4%, 대출만기 20년) : <span id="khaiResult">0원</span> <span id="khaiPrice">0원</span>-->
                </div>
                <canvas id="comparisonChart" width=100% height="50px"></canvas>
            </div>
        </div>
    </div>

<!--  추천 아파트 무한 스크롤 생성  -->
    <!--  정렬 기준 버튼  -->
    <div class="btn-group bg-secondary p-2 g-2 mb-3 rounded-pill shadow" role="group" aria-label="Sort options">
        <input type="radio" class="btn-check" name="sortOptions" id="sortHighPrice" autocomplete="off" checked>
        <label class="btn btn-secondary btn-sm rounded-pill px-3 py-2 fw-bold" for="sortHighPrice">높은 실거래가 순</label>

        <input type="radio" class="btn-check" name="sortOptions" id="sortLowPrice" autocomplete="off">
        <label class="btn btn-secondary btn-sm rounded-pill px-3 py-2 fw-bold" for="sortLowPrice">낮은 실거래가 순</label>

        <input type="radio" class="btn-check" name="sortOptions" id="sortRecent" autocomplete="off">
        <label class="btn btn-secondary btn-sm rounded-pill px-3 py-2 fw-bold" for="sortRecent">최근 거래일 순</label>
    </div>

    <!--무한 스크롤-->
    <div id="apartmentContainer" class="row g-2"></div>
    <div id="loadingIndicator" class="text-center my-3 d-none">로딩 중...</div>
</div>


<!--팝업창-->
<div th:replace="real_income_popup :: realIncomePopup"></div>

<!--header-->
<th:block th:replace="fragments/header :: scripts"></th:block>

<!--footer-->
<footer th:replace="fragments/footer :: footer"></footer>

<!--Javascript-->
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 사용자 정의 JS -->
<script th:src="@{/js/home.js}"></script>
<script th:src="@{/js/real_income.js}"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {

        ///////////////////////////////////////////
        // 연소득 데이터 DB에서 받아오는 것으로 수정해야함
        ///////////////////////////////////////////
        let annualIncome = 50000000; // 연소득 수정해야함

        const incomeInput = document.getElementById('incomeInput');
        const yearsInput = document.getElementById('yearsInput');
        const percentageInput = document.getElementById('percentageInput');
        const outputText = document.getElementById('outputText');

        // Function to update output text dynamically
        function updateOutput() {
            const income = parseInt(incomeInput.value) || 50000000; // Default to 5000 if empty
            const years = parseInt(yearsInput.value) || '20'; // Default to '20' if empty
            const percentage = parseInt(percentageInput.value) || 25; // Default to 25 if empty

            annualIncome = income; // 연소득 수정해야함

            outputText.innerHTML = `${years}년 동안 내 소득 ${income}만 원의 ${percentage}% 이하를<br>`;
        }

        // Event listeners for real-time updates
        incomeInput.addEventListener('input', updateOutput);
        yearsInput.addEventListener('input', updateOutput);
        percentageInput.addEventListener('input', updateOutput);

        // Initialize output on page load
        updateOutput();

        // 타임리프에서 데이터 받기
        const userId = /*[[${session.user_id}]]*/ '';

        //
        // 데이터 DB에서 받아오는 것으로 연소득 수정해야함
        // const annualIncome = parseInt(/*[[${annualIncome}]]*/ 0) || 0;

        const items = /*[[${items}]]*/ [];
        const cityText = /*[[${cityText}]]*/ '';
        const districtText = /*[[${districtText}]]*/ '';

        if (userId) {
            // API 호출
            fetch('/mydata-api/account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({ 'user_id': userId })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('계좌 데이터를 불러오는데 실패했습니다.');
                    }
                    return response.json();
                })
                .then(data => {
                    const totalBalance = data.currentTotal || 0;

                    // 총합 표시 업데이트
                    document.getElementById('totalBalance').textContent = `${numberToKorean(totalBalance)}`;

                    // K-HAI 대출 가능 금액 계산
                    calculateAndDisplayLoanAmount(totalBalance);

                    // PIR 계산
                    calculatePIR(totalBalance, annualIncome);

                    // 추천 아파트 가격 차트 생성
                    createComparisonChart(annualIncome, totalBalance);

                    // Max Recommended Price 계산
                    const maxRecommendedPrice = calculateMaxRecommendedPrice(totalBalance, annualIncome);

                    const filteredApartments = filterApartmentsByPrice(items, maxRecommendedPrice);
                    renderFilteredApartments(filteredApartments);
                })
                .catch(error => {
                    console.error('Error fetching account data:', error);
                    document.getElementById('totalBalance').textContent = '데이터를 불러오는데 실패했습니다.';
                });
        } else {
            console.error('User ID가 제공되지 않았습니다.');
            document.getElementById('totalBalance').textContent = '사용자 정보를 확인해주세요.';
        }

// 숫자 형식 바꾸기
        function formatNumber(number) {
            return new Intl.NumberFormat('ko-KR').format(number);
        }

// 가격 문자열을 한글 금액 표현으로 변환
        function numberToKorean(number) {
            if (!number || isNaN(number)) return '0원';

            const units = ['', '만', '억', '조', '경'];
            let result = '';
            let unitIndex = 0;

            while (number > 0) {
                const part = number % 10000;
                if (part > 0) {
                    result = `${formatNumber(part)}${units[unitIndex]} ` + result;
                }
                number = Math.floor(number / 10000);
                unitIndex++;
            }

            return result.trim() + '원';
        }

// PIR 지수 계산
        function calculatePIR(totalBalance, annualIncome) {
            const pirResult = annualIncome * 11.2;
            const pirPrice = pirResult + totalBalance;

            // HTML 업데이트
            // document.getElementById('pirResult').textContent = numberToKorean(pirResult);
            // document.getElementById('pirPrice').textContent = numberToKorean(pirPrice);
        }

// K-HAI 계산 함수 정의
        function calculateLoanAmount(monthlyIncome, interestRate, loanTermMonths) {
            // 월 상환 가능 금액: 소득의 25.7%
            const monthlyRepayment = monthlyIncome * 0.257;

            // 월 이자율
            const monthlyInterestRate = interestRate / 12;

            // 대출 가능 금액(PV) 계산
            return (
                monthlyRepayment *
                ((Math.pow(1 + monthlyInterestRate, loanTermMonths) - 1) /
                    (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, loanTermMonths)))
            );
        }

// 대출 가능 금액 계산 및 업데이트
        function calculateAndDisplayLoanAmount(totalBalance) {
            const monthlyIncome = annualIncome / 12; // 월 소득
            const interestRate = 0.04; // 연 이자율 (4%)
            const loanTermMonths = 20 * 12; // 대출 기간 (20년)

            // 대출 가능 금액 계산
            const loanAmount = calculateLoanAmount(monthlyIncome, interestRate, loanTermMonths);

            // K-HAI 추천 아파트 금액 계산
            const roundedLoanAmount = Math.round(loanAmount / 10000) * 10000;
            const roundedKHAIPrice = Math.round((loanAmount + totalBalance) / 10000) * 10000;

            // K-HAI 결과 업데이트
            // document.getElementById('khaiResult').textContent = numberToKorean(roundedLoanAmount);
            // document.getElementById('khaiPrice').textContent = numberToKorean(roundedKHAIPrice);
        }

// 추천 아파트 가격 차트 생성
        function createComparisonChart(annualIncome, totalBalance) {
            const pirResult = annualIncome * 11.2;
            const pirPrice = pirResult + totalBalance;
            const loanAmount = calculateLoanAmount(annualIncome / 12, 0.04, 20 * 12); // Replace with actual calculation
            const khaiPrice = Math.round((loanAmount + totalBalance) / 10000) * 10000;

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            document.head.appendChild(script);

            script.onload = function () {
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['PIR 기준 가격', 'K-HAI 기준 가격'],
                        datasets: [
                            {
                                label: '가격 비교 (원)',
                                data: [pirPrice, khaiPrice],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)', // PIR Price
                                    'rgba(75, 192, 192, 0.7)', // K-HAI Price
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(75, 192, 192, 1)',
                                ],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return numberToKorean(context.raw);
                                    },
                                },
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return numberToKorean(value);
                                    },
                                },
                            },
                        },
                    },
                });
            };
        }

// 추천 아파트 리스트 무한 스크롤 동적 생성
        let displayedApartments = [];
        let currentIndex = 0;
        const itemsPerLoad = 12;
        let isLoading = false;

        const container = document.getElementById('apartmentContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');

        let maxRecommendedPrice = 0; // Initialize max price

        // Function to calculate maxRecommendedPrice
        function calculateMaxRecommendedPrice(totalBalance, annualIncome) {
            if (isNaN(totalBalance) || isNaN(annualIncome)) {
                console.error('Invalid totalBalance or annualIncome:', totalBalance, annualIncome);
                return 0;
            }

            const pirPrice = annualIncome * 11.2 + totalBalance; // PIR-based price
            const monthlyIncome = annualIncome / 12;
            const loanAmount = calculateLoanAmount(monthlyIncome, 0.04, 20 * 12);
            const roundedKHAIPrice = Math.round((loanAmount + totalBalance) / 10000) * 10000;

            console.log('PIR Price:', pirPrice);
            console.log('K-HAI Price:', roundedKHAIPrice);

            maxRecommendedPrice = Math.max(pirPrice, roundedKHAIPrice);
            console.log('Final Max Recommended Price:', maxRecommendedPrice);
            return maxRecommendedPrice;
        }

        // Function to filter apartments
        function filterApartmentsByPrice(apartments, maxRecommendedPrice) {
            return apartments.filter(apartment => {
                const dealAmount = parseInt(apartment.dealAmount.replace(/,/g, '').replace(/[^0-9]/g, ''), 10) * 10000;
                if (isNaN(dealAmount)) {
                    console.error('Invalid dealAmount:', apartment.dealAmount);
                    return false;
                }
                console.log('Filtering Max Recommended Price:', maxRecommendedPrice);
                return dealAmount <= maxRecommendedPrice;
            });
        }

        // Function to create a card
        function createApartmentCard(apartment) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'col-md-4 d-flex align-items-stretch'; // 부트스트랩의 그리드 시스템

            // Inner box container for styling
            const boxDiv = document.createElement('div');
            boxDiv.className = 'box mb-0 d-flex align-items-center flex-fill p-4 ';

            // Content section: Main container
            const contentContainer = document.createElement('div');
            contentContainer.className = 'w-100';

            // Apartment Name
            const aptName = document.createElement('h5');
            aptName.textContent = apartment.aptNm;
            aptName.className = 'text-dark fw-bold mb-2';
            contentContainer.appendChild(aptName);

            // Price and Recent Deal Date
            const priceDiv = document.createElement('div');
            priceDiv.className = 'mb-2';

            const price = document.createElement('span');
            price.className = 'price text-primary fw-bold me-2'; // 여백 추가
            price.textContent = `${numberToKorean(parseInt(apartment.dealAmount.replace(/,/g, '')) * 10000)}`;
            priceDiv.appendChild(price);

            const recentDeal = document.createElement('span');
            recentDeal.className = 'text-muted';
            recentDeal.textContent = `(${apartment.dealYear}년 ${apartment.dealMonth}월 ${apartment.dealDay}일)`;
            priceDiv.appendChild(recentDeal);

            contentContainer.appendChild(priceDiv);

            // Location Details
            const locationDiv = document.createElement('div');
            locationDiv.className = 'text-muted mb-2';

            const citySpan = document.createElement('span');
            citySpan.textContent = cityText; // Ensure `cityText` is defined in the scope
            locationDiv.appendChild(citySpan);

            locationDiv.appendChild(document.createTextNode(' '));

            const districtSpan = document.createElement('span');
            districtSpan.textContent = districtText; // Ensure `districtText` is defined in the scope
            locationDiv.appendChild(districtSpan);

            locationDiv.appendChild(document.createTextNode(' '));

            const umdName = document.createElement('span');
            umdName.textContent = apartment.umdNm;
            locationDiv.appendChild(umdName);

            contentContainer.appendChild(locationDiv);

            // Details
            const details = document.createElement('p');
            details.className = 'text-secondary mb-1';
            details.textContent = `${apartment.aptDong}동 · 전용면적 ${apartment.excluUseAr}m² · ${apartment.floor}층`;
            contentContainer.appendChild(details);

            // Build Year
            const buildYear = document.createElement('p');
            buildYear.className = 'text-secondary mb-0';
            buildYear.textContent = `건축년도 ${apartment.buildYear}년`;
            contentContainer.appendChild(buildYear);

            boxDiv.appendChild(contentContainer);
            cardDiv.appendChild(boxDiv);

            return cardDiv;
        }

        // Event listeners for sorting
        document.getElementById('sortLowPrice').addEventListener('change', () => {
            sortApartments('lowPrice');
        });

        document.getElementById('sortHighPrice').addEventListener('change', () => {
            sortApartments('highPrice');
        });

        document.getElementById('sortRecent').addEventListener('change', () => {
            sortApartments('recentDeal');
        });

        // Function to handle sorting
        function sortApartments(criteria) {
            displayedApartments.sort((a, b) => {
                if (criteria === 'lowPrice' || criteria === 'highPrice') {
                    const priceA = parseInt(a.dealAmount.replace(/,/g, ''), 10);
                    const priceB = parseInt(b.dealAmount.replace(/,/g, ''), 10);
                    return criteria === 'lowPrice' ? priceA - priceB : priceB - priceA; // 높은 실거래가 순
                } else if (criteria === 'recentDeal') {
                    const dateA = new Date(a.dealYear, a.dealMonth - 1, a.dealDay);
                    const dateB = new Date(b.dealYear, b.dealMonth - 1, b.dealDay);
                    return dateB - dateA; // 최근 거래일 순
                }
            });

            container.innerHTML = '';
            currentIndex = 0;
            renderFilteredApartments();
        }

        // Function to render filtered apartments
        function renderFilteredApartments() {
            if (isLoading) return;
            isLoading = true;
            loadingIndicator.classList.remove('d-none');

            setTimeout(() => {
                const endIndex = Math.min(currentIndex + itemsPerLoad, displayedApartments.length);
                for (let i = currentIndex; i < endIndex; i++) {
                    const card = createApartmentCard(displayedApartments[i]);
                    container.appendChild(card);
                }
                currentIndex = endIndex;
                isLoading = false;
                loadingIndicator.classList.add('d-none');

                if (currentIndex >= displayedApartments.length) {
                    window.removeEventListener('scroll', handleScroll);
                }
            }, 500);
        }

        // Infinite scroll handler
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoading && currentIndex < displayedApartments.length) {
                renderMoreApartments();
            }
        }

        // Function to render more apartments
        function renderMoreApartments() {
            if (isLoading) return;

            isLoading = true;
            loadingIndicator.classList.remove('d-none');

            setTimeout(() => {
                const endIndex = Math.min(currentIndex + itemsPerLoad, displayedApartments.length);

                for (let i = currentIndex; i < endIndex; i++) {
                    const card = createApartmentCard(displayedApartments[i]);
                    container.appendChild(card);
                }

                currentIndex = endIndex;
                isLoading = false;
                loadingIndicator.classList.add('d-none');

                // Remove scroll event listener if all items are loaded
                if (currentIndex >= displayedApartments.length) {
                    console.log('All apartments loaded. Removing scroll listener.');
                    window.removeEventListener('scroll', handleScroll);
                }
            }, 500); // Simulate API delay
        }

        // Function to update displayed apartments and enable infinite scroll
        function updateDisplayedApartments() {
            console.log('Updating displayed apartments with maxRecommendedPrice:', maxRecommendedPrice);
            displayedApartments = filterApartmentsByPrice(items, maxRecommendedPrice);
            container.innerHTML = ''; // Clear existing apartments
            currentIndex = 0; // Reset index
            renderMoreApartments(); // Render the first batch

            // Reattach scroll listener for infinite scroll
            window.removeEventListener('scroll', handleScroll);
            window.addEventListener('scroll', handleScroll);
        }

        // Initialization
        function init() {
            fetch('/mydata-api/account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({ user_id: userId })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch account data');
                    }
                    return response.json();
                })
                .then(data => {
                    const totalBalance = data.currentTotal || 0;
                    maxRecommendedPrice = calculateMaxRecommendedPrice(totalBalance, annualIncome);
                    updateDisplayedApartments(); // Update and render apartments

                    // 기본 정렬: 높은 실거래가 순
                    sortApartments('highPrice');
                })
                .catch(error => {
                    console.error('Error fetching account data:', error);
                });
        }

        init(); // Start initialization

    });
</script>

</body>
</html>